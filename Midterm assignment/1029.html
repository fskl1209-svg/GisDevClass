<!doctype html>
<html lang="zh-Hant">
<head>
  <meta http-equiv="Pragma" content="no-cache" />
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css" type="text/css" />
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      margin: 10px;
    }
    .map {
      width: 100%;
      height: 480px;
      margin-bottom: 10px;
    }
    .ol-tooltip {
      position: relative;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 4px;
      color: white;
      padding: 4px 8px;
      opacity: 0.7;
      white-space: nowrap;
      font-size: 12px;
      cursor: default;
      user-select: none;
    }
    .ol-tooltip-measure {
      opacity: 1;
      font-weight: bold;
    }
    .ol-tooltip-static {
      background-color: #ffcc33;
      color: black;
      border: 1px solid white;
    }
    .ol-tooltip-measure:before,
    .ol-tooltip-static:before {
      border-top: 6px solid rgba(0, 0, 0, 0.5);
      border-right: 6px solid transparent;
      border-left: 6px solid transparent;
      content: "";
      position: absolute;
      bottom: -6px;
      margin-left: -7px;
      left: 50%;
    }
    .ol-tooltip-static:before {
      border-top-color: #ffcc33;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>
  <title>ä¸­å€ç”œé»æ¨è–¦åœ°åœ–</title>
</head>
<body>
  <h2>ä¸­å€ç”œé»æ¨è–¦åœ°åœ–</h2>

  <div id="map" class="map"></div>

  <!-- æ§åˆ¶åŠŸèƒ½æŒ‰éˆ• -->
  <form>
    <h4>ğŸ“ åœ°åœ–æ§åˆ¶åŠŸèƒ½</h4>
    <input type="button" value="èµ·å§‹ä½ç½®" onclick="GoInitView();" />
    <input type="button" value="é †æ—‹45åº¦" onclick="AnimateRotateViewRight();" />
    <input type="button" value="é€†æ—‹45åº¦" onclick="AnimateRotateViewLeft();" />
    <input type="button" value="CJSJ" onclick="PanToCJSJ();" />
    <input type="button" value="æ³•èŠ™å°¼" onclick="PanToFFN();" />
    <input type="button" value="æ³•å¸ƒç”œ" onclick="PanToFBT();" />
    <input type="button" value="å›æ†¶ç”œé»" onclick="PanToHYTD();" />
    <input type="button" value="ABæ³•åœ‹äººçš„ç”œé»åº—" onclick="PanToAB();" />
    <input type="button" value="è’”åˆç”œé»äº”æ¬Šåº—" onclick="PanToSTSUTD();" />
  </form>

  <hr>

  <!-- é‡æ¸¬åŠŸèƒ½ -->
  <form>
    <h4>ğŸ“ é‡æ¸¬å·¥å…·</h4>
    <input type="button" value="é–‹å§‹é‡æ¸¬" onclick="startMeasure();" />
    <input type="button" value="åœæ­¢é‡æ¸¬" onclick="stopMeasure();" />
    <label>é‡æ¸¬é¡å‹ï¼š</label>
    <select id="VectorType" onchange="typeSelectChanged();">
      <option value="LineString">è·é›¢é‡æ¸¬</option>
      <option value="Polygon">é¢ç©é‡æ¸¬</option>
    </select>
    <input type="button" value="æ¸…é™¤åœ–å¾µ" onclick="clearVectorFeature();" />
    &nbsp; <span id="labMeasureResult" style="font-weight:bold;color:#333;"></span>
  </form>

  <hr>
  
  <!-- åº—å®¶é€£çµ -->
  <div style="margin-top: 15px;">
    <h4>ğŸ° æ¨è–¦ç”œé»åº—é€£çµ</h4>
    <ul style="line-height:1.8;">
      <li><a href="https://www.facebook.com/CJSJgastronomie/" target="_blank">CJSJ</a></li>
      <li><a href="https://www.facebook.com/fafne.888/" target="_blank">æ³•èŠ™å°¼ FAFFNIR</a></li>
      <li><a href="https://www.arbaking.com.tw/" target="_blank">æ³•å¸ƒç”œ Fabourg</a></li>
      <li><a href="https://www.facebook.com/memorydessert/" target="_blank">å›æ†¶ç”œé» Memory Dessert</a></li>
      <li><a href="https://atelierbaulois.meepshoper.com/" target="_blank">AB æ³•åœ‹äººçš„ç”œé»åº—</a></li>
      <li><a href="https://www.facebook.com/originla/" target="_blank">è’”åˆç”œé»äº”æ¬Šåº—</a></li>
    </ul>
  </div>

  <script>
    //--------------------- åœ°åœ–åˆå§‹åŒ– ---------------------
    const initCenter = ol.proj.fromLonLat([120.6465, 24.1788]);
    const initZoom = 14;

    const view = new ol.View({
      center: initCenter,
      zoom: initZoom,
      rotation: 0,
    });

    const measureLayer = new ol.layer.Vector({
      source: new ol.source.Vector(),
      style: new ol.style.Style({
        fill: new ol.style.Fill({ color: "rgba(255, 255, 255, 0.2)" }),
        stroke: new ol.style.Stroke({ color: "#ffcc33", width: 2 }),
        image: new ol.style.Circle({
          radius: 7,
          fill: new ol.style.Fill({ color: "#ffcc33" }),
        }),
      }),
    });

    const map = new ol.Map({
      target: "map",
      layers: [new ol.layer.Tile({ source: new ol.source.OSM() }), measureLayer],
      view: view,
    });

//--------------------- åœ°åœ–æ§åˆ¶åŠŸèƒ½ ---------------------
//------------- åŠ ä¸Šåœ°æ¨™ï¼ˆMarkersï¼‰ -------------
const locations = [
  { name: "CJSJ", coord: [120.6640, 24.1448] },
  { name: "æ³•èŠ™å°¼", coord: [120.6643, 24.1507] },
  { name: "æ³•å¸ƒç”œ", coord: [120.6524, 24.1599] },
  { name: "å›æ†¶ç”œé»", coord: [120.6766, 24.1641] },
  { name: "ABæ³•åœ‹äººçš„ç”œé»åº—", coord: [120.6612, 24.1250] },
  { name: "è’”åˆç”œé»äº”æ¬Šåº—", coord: [120.6588, 24.1250] },
];

// å»ºç«‹ä¸€å€‹å‘é‡ä¾†æº (Vector Source)
const markerSource = new ol.source.Vector();

// ç‚ºæ¯å€‹åœ°é»å»ºç«‹ Featureï¼ˆåœ°æ¨™ï¼‰
locations.forEach((loc) => {
  const feature = new ol.Feature({
    geometry: new ol.geom.Point(ol.proj.fromLonLat(loc.coord)),
    name: loc.name,
  });
  markerSource.addFeature(feature);
});

// æ¨£å¼è¨­å®šï¼šé»ƒè‰²åœ“é» + åç¨±æ¨™ç±¤
const markerStyle = new ol.style.Style({
  image: new ol.style.Circle({
    radius: 6,
    fill: new ol.style.Fill({ color: "#ffcc33" }),
    stroke: new ol.style.Stroke({ color: "#333", width: 1 }),
  }),
  text: new ol.style.Text({
    font: "12px Microsoft JhengHei",
    offsetY: -15,
    fill: new ol.style.Fill({ color: "#000" }),
    stroke: new ol.style.Stroke({ color: "#fff", width: 3 }),
  }),
});

// å‰µå»ºåœ°æ¨™åœ–å±¤
const markerLayer = new ol.layer.Vector({
  source: markerSource,
  style: function (feature) {
    const style = markerStyle.clone();
    style.getText().setText(feature.get("name"));
    return style;
  },
});

// å°‡åœ°æ¨™åœ–å±¤åŠ å…¥åœ°åœ–
map.addLayer(markerLayer);

//--------------------- é»æ“Šåœ°æ¨™é¡¯ç¤ºåç¨± ---------------------
const popup = document.createElement("div");
popup.style.background = "white";
popup.style.padding = "5px 10px";
popup.style.borderRadius = "5px";
popup.style.border = "1px solid #ccc";
popup.style.fontFamily = "Microsoft JhengHei";
popup.style.fontSize = "12px";
const popupOverlay = new ol.Overlay({
  element: popup,
  positioning: "bottom-center",
  offset: [0, -10],
});
map.addOverlay(popupOverlay);

map.on("singleclick", function (evt) {
  const feature = map.forEachFeatureAtPixel(evt.pixel, (f) => f);
  if (feature && feature.get("name")) {
    popup.innerHTML = feature.get("name");
    popupOverlay.setPosition(evt.coordinate);
  } else {
    popupOverlay.setPosition(undefined);
  }
});

    const CJSJ = ol.proj.fromLonLat([120.6640, 24.1448])// CJSJ
    const FFN = ol.proj.fromLonLat([120.6643, 24.1507]) // æ³•èŠ™å°¼
    const FBT = ol.proj.fromLonLat([120.6524, 24.1599]) // æ³•å¸ƒç”œ
    const HYTD = ol.proj.fromLonLat([120.6766, 24.1641]) // å›æ†¶ç”œé»
    const AB = ol.proj.fromLonLat([120.6612, 24.1250]) // ABæ³•åœ‹äººçš„ç”œé»åº—
    const STSUTD = ol.proj.fromLonLat([120.6588, 24.1250]) // è’”åˆç”œé»

    function GoInitView() {
      view.animate({ center: initCenter, duration: 1500 });
    }

    function PanToCJSJ() {
      view.animate({ center: CJSJ, duration: 1500 });
    }

    function PanToFFN() {
      view.animate({ center: FFN, duration: 1500 });
    }

    function PanToFBT() {
      view.animate({ center: FBT, duration: 1500 });
    }

    function PanToHYTD() {
      view.animate({ center: HYTD, duration: 1500 });
    }

    function PanToAB() {
      view.animate({ center: AB, duration: 1500 });
    }

    function PanToSTSUTD() {
      view.animate({ center: STSUTD, duration: 1500 });
    }

    function FlyToTMNS() {
      const duration = 2000;
      const zoom = view.getZoom();
      view.animate(
        { zoom: zoom - 2, duration: duration / 2 },
        { center: tmns, duration: duration },
        { zoom: zoom, duration: duration / 2 }
      );
    }

    function BounceToWFP() {
      const duration = 2000;
      const parts = 4;
      let bounce = 0;

      function bounceStep() {
        const offset = Math.sin((bounce / parts) * Math.PI) * 200;
        const newCenter = [wfp[0], wfp[1] + offset / Math.pow(2, bounce)];
        view.animate({
          center: newCenter,
          duration: duration / parts,
          complete: () => {
            bounce++;
            if (bounce < parts) bounceStep();
            else view.animate({ center: wfp, duration: 500 });
          },
        });
      }

      bounceStep();
    }

    function SpinToTMNS() {
      const duration = 3000;
      const start = +new Date();
      const rotationStart = view.getRotation();
      const rotationEnd = rotationStart + Math.PI * 2;

      function spinAnimation() {
        const elapsed = +new Date() - start;
        const fraction = elapsed / duration;
        if (fraction < 1) {
          view.setRotation(rotationStart + (rotationEnd - rotationStart) * fraction);
          view.setCenter([
            fcu[0] + (tmns[0] - fcu[0]) * fraction,
            fcu[1] + (tmns[1] - fcu[1]) * fraction,
          ]);
          requestAnimationFrame(spinAnimation);
        } else {
          view.setRotation(rotationEnd);
          view.setCenter(tmns);
        }
      }
      spinAnimation();
    }

    //--------------------- é‡æ¸¬åŠŸèƒ½ ---------------------
    let draw, measureTooltip, measureTooltipElement;
    let vectorType = "LineString";

    function startMeasure() {
      stopMeasure();
      addInteraction();
    }

    function stopMeasure() {
      if (draw) {
        map.removeInteraction(draw);
        draw = null;
      }
    }

    function clearVectorFeature() {
      measureLayer.getSource().clear();
      if (measureTooltipElement) {
        measureTooltipElement.parentNode.removeChild(measureTooltipElement);
      }
      document.getElementById("labMeasureResult").textContent = "";
    }

    function typeSelectChanged() {
      vectorType = document.getElementById("VectorType").value;
      stopMeasure();
    }

    function createMeasureTooltip() {
      if (measureTooltipElement) {
        measureTooltipElement.parentNode.removeChild(measureTooltipElement);
      }
      measureTooltipElement = document.createElement("div");
      measureTooltipElement.className = "ol-tooltip ol-tooltip-measure";
      measureTooltip = new ol.Overlay({
        element: measureTooltipElement,
        offset: [0, -15],
        positioning: "bottom-center",
      });
      map.addOverlay(measureTooltip);
    }

    function addInteraction() {
      const source = measureLayer.getSource();
      draw = new ol.interaction.Draw({
        source: source,
        type: vectorType,
        style: new ol.style.Style({
          fill: new ol.style.Fill({ color: "rgba(255, 255, 255, 0.2)" }),
          stroke: new ol.style.Stroke({
            color: "rgba(0, 0, 0, 0.5)",
            lineDash: [10, 10],
            width: 2,
          }),
          image: new ol.style.Circle({
            radius: 5,
            stroke: new ol.style.Stroke({ color: "rgba(0, 0, 0, 0.7)" }),
            fill: new ol.style.Fill({ color: "rgba(255, 255, 255, 0.2)" }),
          }),
        }),
      });

      map.addInteraction(draw);
      createMeasureTooltip();

      let listener;
      draw.on("drawstart", function (evt) {
        const sketch = evt.feature;
        let tooltipCoord = evt.coordinate;

        listener = sketch.getGeometry().on("change", function (evt) {
          const geom = evt.target;
          let output;
          if (geom instanceof ol.geom.Polygon) {
            output = formatArea(geom);
            tooltipCoord = geom.getInteriorPoint().getCoordinates();
          } else if (geom instanceof ol.geom.LineString) {
            output = formatLength(geom);
            tooltipCoord = geom.getLastCoordinate();
          }
          measureTooltipElement.innerHTML = output;
          measureTooltip.setPosition(tooltipCoord);
          document.getElementById("labMeasureResult").textContent = "é‡æ¸¬çµæœï¼š" + output;
        });
      });

      draw.on("drawend", function () {
        measureTooltipElement.className = "ol-tooltip ol-tooltip-static";
        measureTooltip.setOffset([0, -7]);
        measureTooltipElement = null;
        createMeasureTooltip();
        ol.Observable.unByKey(listener);
      });
    }

    function formatLength(line) {
      const length = ol.sphere.getLength(line);
      return length > 1000
        ? (Math.round((length / 1000) * 100) / 100) + " å…¬é‡Œ"
        : Math.round(length) + " å…¬å°º";
    }

    function formatArea(polygon) {
      const area = ol.sphere.getArea(polygon);
      return area > 1000000
        ? (Math.round((area / 1000000) * 100) / 100) + " å¹³æ–¹å…¬é‡Œ"
        : Math.round(area) + " å¹³æ–¹å…¬å°º";
    }

  </script>
</body>
</html>
