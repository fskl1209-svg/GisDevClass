<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ä¸­å€ç”œé»æ¨è–¦åœ°åœ–</title>
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css">
<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>
<style>
  body { font-family: "Microsoft JhengHei", sans-serif; margin:10px; }
  #map { width:100%; height:520px; border:1px solid #aaa; }
  .panel { margin-top:10px; padding:10px; border:1px solid #ccc; background:#f9f9f9; }
  button { margin:2px; }
  input[type="text"] { width:120px; }
  #popup { 
    position:absolute; 
    background:white; 
    padding:5px 10px; 
    border-radius:5px; 
    border:1px solid #ccc; 
    font-family:Microsoft JhengHei; 
    font-size:12px; 
    display:none; 
    z-index:999;
  }
</style>
</head>

<body>

<h2>ğŸ° ä¸­å€ç”œé»æ¨è–¦åœ°åœ–</h2>

<div id="map"></div>

<!-- æŒ‡åŒ—é‡ -->
<img src="https://upload.wikimedia.org/wikipedia/commons/e/ec/Compass_rose_pale.svg"
     style="position:absolute;top:15px;right:15px;width:60px;z-index:999;">

<!-- Popup å®¹å™¨ -->
<div id="popup"></div>

<!-- åŠŸèƒ½æ§åˆ¶é¢æ¿ -->
<div class="panel">
  <h4>ğŸ“ åœ°åœ–æ§åˆ¶</h4>
  <button onclick="GoInitView()">èµ·å§‹ä½ç½®</button>
  <button onclick="PanToCJSJ()">CJSJ</button>
  <button onclick="PanToFFN()">æ³•èŠ™å°¼</button>
  <button onclick="PanToFBT()">æ³•å¸ƒç”œ</button>
  <button onclick="PanToHYTD()">å›æ†¶ç”œé»</button>
  <button onclick="PanToAB()">AB</button>
  <button onclick="PanToSTSUTD()">è’”åˆç”œé»</button>

  <hr>

  <h4>ğŸ“ é‡æ¸¬å·¥å…·</h4>
  <button onclick="addMeasure('LineString')">æ¸¬è·</button>
  <button onclick="addMeasure('Polygon')">æ¸¬é¢</button>

  <hr>

  <h4>ğŸ” åº§æ¨™å®šä½</h4>
  ç¶“åº¦ <input type="text" id="lon" placeholder="120.6483">
  ç·¯åº¦ <input type="text" id="lat" placeholder="24.1799">
  <button onclick="goToCoord()">å®šä½</button>

  <hr>

  <h4>ğŸ” æœå°‹ç”œé»åº—</h4>
  <input type="text" id="searchBox" placeholder="è¼¸å…¥åº—å®¶åç¨±">
  <button onclick="searchLocation()">æœå°‹</button>

  <hr>

  <h4>ğŸ“Š åº•åœ–é€æ˜åº¦</h4>
  <input type="range" min="0" max="1" step="0.1" value="1" onchange="setOpacity(this.value)">

  <hr>

  <!-- â­ æ–°å¢ï¼šæœ€æ„›ç¯©é¸ -->
  <h4>â¤ï¸ æœ€æ„›ç¯©é¸</h4>
  <label>
    <input type="checkbox" id="favFilter" onchange="toggleFavFilter(this.checked)">
    åªé¡¯ç¤ºæœ€æ„›åº—å®¶
  </label>
</div>

<!-- ç”œé»åº—æ¸…å–® -->
<div class="panel">
  <h4>ğŸ“‹ ç”œé»åº—æ¸…å–®ï¼ˆé»æ“Šå®šä½ï¼‰</h4>
  <ul id="shopList" style="list-style:none;padding-left:0;"></ul>
</div>

<script>
/* ===== åœ°åœ–åˆå§‹åŒ– ===== */
const initCenter = ol.proj.fromLonLat([120.6465,24.1788]);
const view = new ol.View({ center:initCenter, zoom:14 });
const raster = new ol.layer.Tile({ source: new ol.source.OSM() });
const map = new ol.Map({ target:"map", layers:[raster], view:view });

/* ===== ç”œé»é»ä½è³‡æ–™ ===== */
const locations = [
  { name:"CJSJ", coord:[120.6640,24.1448],
    info:`<b>CJSJ</b><br>æ³•å¼æ‰‹å·¥ç”œé»åº—<br>
    <a href='https://www.facebook.com/CJSJgastronomie' target='_blank'>FBç²‰çµ²å°ˆé </a>` },

  { name:"æ³•èŠ™å°¼", coord:[120.6643,24.1507],
    info:`<b>æ³•èŠ™å°¼</b><br>æ³•å¼çƒ˜ç„™ç”œé»<br>
    <a href='https://www.facebook.com/fafne.888/?locale=zh_TW' target='_blank'>FBç²‰çµ²å°ˆé </a>` },

  { name:"æ³•å¸ƒç”œ", coord:[120.6524,24.1599],
    info:`<b>æ³•å¸ƒç”œ</b><br>æ³•å¼ç„¦ç³–å¸ƒä¸<br>
    <a href='https://www.facebook.com/FaDiTianDianShiJiaArsPatisserie/?locale=zh_TW' target='_blank'>FBç²‰çµ²å°ˆé </a>` },

  { name:"å›æ†¶ç”œé»", coord:[120.6766,24.1641],
    info:`<b>å›æ†¶ç”œé»</b><br>æ‡·èˆŠæ‰‹ä½œç”œé»<br>
    <a href='https://www.facebook.com/memorycakesweet/?locale=zh_TW' target='_blank'>FBç²‰çµ²å°ˆé </a>` },

  { name:"AB æ³•åœ‹äººçš„ç”œé»åº—", coord:[120.6612,24.1250],
    info:`<b>AB</b><br>å¯éº—éœ²å°ˆè³£<br>
    <a href='https://www.facebook.com/atelierbaulois/?locale=zh_TW' target='_blank'>FBç²‰çµ²å°ˆé </a>` },

  { name:"è’”åˆç”œé»", coord:[120.6588,24.1250],
    info:`<b>è’”åˆç”œé»</b><br>æ‰‹å·¥ç”Ÿä¹³æ²<br>
    <a href='https://www.facebook.com/originla/?locale=zh_TW' target='_blank'>FBç²‰çµ²å°ˆé </a>` }
];

/* ===== è®€å–æœ€æ„›è³‡æ–™ ===== */
let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

/* â­ æ–°å¢ï¼šæ˜¯å¦åªé¡¯ç¤ºæœ€æ„›é–‹é—œ ===== */
let showOnlyFav = false;

/* ===== å»ºç«‹åœ–å±¤ ===== */
const markerSource = new ol.source.Vector();
locations.forEach(l=>{
  const feature = new ol.Feature({
    geometry:new ol.geom.Point(ol.proj.fromLonLat(l.coord)),
    name:l.name,
    info:l.info,
    isFavorite: favorites.includes(l.name) // æœ€æ„›ç‹€æ…‹
  });
  markerSource.addFeature(feature);
});

const markerLayer = new ol.layer.Vector({
  source: markerSource,
  style: f => {
    const isFav = f.get('isFavorite');
    // â­ è‹¥é–‹å•Ÿã€Œåªé¡¯ç¤ºæœ€æ„›ã€ï¼Œä¸”æ­¤é»ä¸æ˜¯æœ€æ„›ï¼Œå°±ä¸ç•«å‡º
    if (showOnlyFav && !isFav) {
      return null;
    }
    return new ol.style.Style({
      image: new ol.style.Circle({
        radius:6,
        fill: new ol.style.Fill({color: isFav ? "#ff3333" : "#ffcc33"}), // ç´…è‰²æœ€æ„›
        stroke: new ol.style.Stroke({color:"#333", width:1})
      }),
      text: new ol.style.Text({
        text: f.get("name"),
        offsetY:-15,
        fill:new ol.style.Fill({color:"#000"}),
        stroke:new ol.style.Stroke({color:"#fff", width:3})
      })
    });
  }
});
map.addLayer(markerLayer);

/* ===== Popup Overlay + æœ€æ„›æŒ‰éˆ• ===== */
const popup = document.getElementById('popup');
const popupOverlay = new ol.Overlay({ element: popup, offset:[0,-10] });
map.addOverlay(popupOverlay);

map.on('singleclick', function(evt){
  const feature = map.forEachFeatureAtPixel(evt.pixel, f => f);
  if(feature && feature.get('name')){
    const name = feature.get('name');
    const isFav = feature.get('isFavorite');
    popup.innerHTML = feature.get('info') +
      `<br><button onclick="toggleFavorite('${name}')">${isFav ? 'ç§»é™¤æœ€æ„›' : 'åŠ å…¥æœ€æ„›'}</button>`;
    popup.style.display = 'block';
    popupOverlay.setPosition(evt.coordinate);
  } else {
    popup.style.display = 'none';
  }
});

/* ===== ç”œé»åº—æ¸…å–®ï¼ˆæ”¯æ´ç¯©é¸ï¼‰ ===== */
const shopList = document.getElementById("shopList");

function renderShopList(){
  shopList.innerHTML = "";

  // è‹¥åªé¡¯ç¤ºæœ€æ„› -> åªåˆ—å‡º favorites ä¸­æœ‰çš„åº—
  let listData = locations;
  if (showOnlyFav) {
    listData = locations.filter(l => favorites.includes(l.name));
  }

  if (listData.length === 0) {
    const li = document.createElement("li");
    li.textContent = "ï¼ˆç›®å‰æ²’æœ‰æœ€æ„›åº—å®¶ï¼‰";
    shopList.appendChild(li);
    return;
  }

  listData.forEach(l=>{
    const li = document.createElement("li");
    li.innerHTML = "ğŸ° " + l.name;
    li.style.cursor="pointer";
    li.onclick = ()=>{
      const coord = ol.proj.fromLonLat(l.coord);
      view.animate({center:coord, zoom:16, duration:1200});

      const feature = markerSource.getFeatures().find(f=>f.get('name')===l.name);
      popup.innerHTML = feature.get('info') +
        `<br><button onclick="toggleFavorite('${l.name}')">${feature.get('isFavorite') ? 'ç§»é™¤æœ€æ„›' : 'åŠ å…¥æœ€æ„›'}</button>`;
      popup.style.display='block';
      popupOverlay.setPosition(coord);
    };
    shopList.appendChild(li);
  });
}

/* ===== åˆ‡æ›æœ€æ„›å‡½æ•¸ ===== */
function toggleFavorite(name){
  const feature = markerSource.getFeatures().find(f => f.get('name')===name);
  if(!feature) return;
  let isFav = feature.get('isFavorite');

  if(isFav){
    favorites = favorites.filter(n => n!==name);
    feature.set('isFavorite', false);
  } else {
    favorites.push(name);
    feature.set('isFavorite', true);
  }

  localStorage.setItem('favorites', JSON.stringify(favorites));
  markerLayer.changed(); // æ›´æ–°æ¨£å¼
  renderShopList();      // â­ æ›´æ–°æ¸…å–®
  popup.style.display='none';
}

/* ===== æœ€æ„›ç¯©é¸é–‹é—œ ===== */
function toggleFavFilter(checked){
  showOnlyFav = checked;
  markerLayer.changed(); // é‡æ–°å¥—ç”¨ styleï¼Œéš±è—éæœ€æ„›
  renderShopList();      // æ›´æ–°åº—å®¶æ¸…å–®
}

/* ===== åˆæ¬¡ç”¢ç”Ÿåº—å®¶æ¸…å–® ===== */
renderShopList();

/* ===== PanTo åŠŸèƒ½ ===== */
function GoInitView(){ view.animate({center:initCenter, zoom:14, duration:1200}); }
function PanToCJSJ(){ view.animate({center:ol.proj.fromLonLat([120.6640,24.1448]), duration:1200}); }
function PanToFFN(){ view.animate({center:ol.proj.fromLonLat([120.6643,24.1507]), duration:1200}); }
function PanToFBT(){ view.animate({center:ol.proj.fromLonLat([120.6524,24.1599]), duration:1200}); }
function PanToHYTD(){ view.animate({center:ol.proj.fromLonLat([120.6766,24.1641]), duration:1200}); }
function PanToAB(){ view.animate({center:ol.proj.fromLonLat([120.6612,24.1250]), duration:1200}); }
function PanToSTSUTD(){ view.animate({center:ol.proj.fromLonLat([120.6588,24.1250]), duration:1200}); }

/* ===== é‡æ¸¬å·¥å…· ===== */
let draw;
const measureSource = new ol.source.Vector();
const measureLayer = new ol.layer.Vector({ source: measureSource });
map.addLayer(measureLayer);
function addMeasure(type){
  if (draw) {
    map.removeInteraction(draw);
  }
  draw = new ol.interaction.Draw({ source: measureSource, type:type });
  map.addInteraction(draw);
}

// ç¶“ç·¯åº¦å®šä½
function goToCoord(){
  const lon=parseFloat(document.getElementById("lon").value);
  const lat=parseFloat(document.getElementById("lat").value);
  if(isNaN(lon)||isNaN(lat)){ alert("è«‹è¼¸å…¥æ­£ç¢ºç¶“ç·¯åº¦"); return; }
  view.animate({center:ol.proj.fromLonLat([lon,lat]), zoom:16, duration:1200});
}

// åº•åœ–é€æ˜åº¦
function setOpacity(val){ raster.setOpacity(val); }

// æœå°‹åŠŸèƒ½
function searchLocation(){
  const keyword = document.getElementById('searchBox').value.trim();
  if(!keyword) return;
  const found = locations.find(l=>l.name.includes(keyword));
  if(found){
    const coord = ol.proj.fromLonLat(found.coord);
    view.animate({center:coord, zoom:16, duration:1200});
    const feature = markerSource.getFeatures().find(f=>f.get('name')===found.name);
    popup.innerHTML = feature.get('info') +
      `<br><button onclick="toggleFavorite('${found.name}')">${feature.get('isFavorite') ? 'ç§»é™¤æœ€æ„›' : 'åŠ å…¥æœ€æ„›'}</button>`;
    popup.style.display='block';
    popupOverlay.setPosition(coord);
  } else { alert("æ‰¾ä¸åˆ°ç¬¦åˆçš„åº—å®¶ï¼"); }
}
</script>
</body>
</html>
